<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
    <title>Product App</title>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/3.4.0/css/bootstrap.min.css" integrity="sha384-PmY9l28YgO4JwMKbTvgaS7XNZJ30MK9FAZjjzXtlqyZCqBY6X6bXIkM++IkyinN+" crossorigin="anonymous">
</head>
<body>
    <div class="navbar navbar-inverse navbar-fixed-top">
        <div class="container">
            <a class="navbar-brand" href="/">Movies</a>
            <div class="navbar-header">
            </div>
            <div class="navbar-collapse collapse">
                <ul class="nav navbar-nav">
                    <li>Home</li>
                </ul>
            </div>
        </div>
    </div>

    <div id="selection" class="container" style="padding-top:70px;text-align:center;">
        <div class="row">
            <select id="category-select">
                <option value="all">All</option>
                <option value="comedy">Comedy</option>
                <option value="action">Action</option>
            </select>
        </div>
    </div>
    <div id="movies" class="container" style="text-align:center;">
    </div>

    <script src="https://ajax.aspnetcdn.com/ajax/jQuery/jquery-2.0.3.min.js"></script>
    <script>
        var uri = 'api/movies';

        function documentready(fn) {
            if (document.attachEvent ? document.readyState === "complete" : document.readyState !== "loading") {
                fn();
            } else {
                document.addEventListener('DOMContentLoaded', fn);
            }
        }

        document.addEventListener("change", (e) => {
            var element = e.target;
            if (element && element.id == "category-select") {
                var movies = document.getElementById("movies");
                movies.innerHTML = "";
                var category = element.options[element.selectedIndex].value;
                if (element.options[element.selectedIndex].value == "all") {
                    grabAllMovies();
                } else {
                    fetch('/api/movies/getmoviesbycategory/'+category).
                        then((response) => {
                            if (response.status !== 200) {
                                console.log('Looks like there was a problem. Status Code: ' +
                                    response.status);
                                return;
                            }
                            response.json().then(function (data) {
                                var div;
                                for (let i = 0; i < data.length; i++) {
                                    if (i % 3 == 0) {
                                        div = document.createElement("div");
                                        div.className = "row";
                                        document.getElementById("movies").appendChild(div);
                                    }
                                    var movie = document.createElement("div");
                                    movie.className = "col-md-3";
                                    movie.style = "text-align:center; margin:10px; border-radius: 10px; border:3px; background-color:#afe6af; padding-bottom:5px; padding-top:5px;";
                                    movie.innerHTML = "<img src='" + data[i].imageurl + "' style='height:auto; width:25%;'><h2>" + data[i].Title + "</h2><p>" + data[i].Category + "</p><button data-id='" + data[i].Id + "' id='moreDetails' class='btn btn-success'>More Details</button>";
                                    div.appendChild(movie);
                                }
                            });
                        }).catch((err) => {
                            console.log("api not working");
                        });
                }
            }
        })

        document.addEventListener('click', (e) => {
            if (e.target && e.target.id == 'moreDetails') {
                console.log(this);
                var element = e.target;
                var id = element.getAttribute('data-id');
                fetch('/api/movies/getmovie/' + id).
                    then((response) => {
                        if (response.status !== 200) {
                            console.log('Looks like there was a problem. Status Code: ' +
                                response.status);
                            return;
                        }
                        response.json().then(function (data) {
                            console.log(element);
                            var paragraph = element.parentNode.getElementsByClassName("details");
                            if (paragraph.length == 0) {
                                var paragraph = document.createElement("p");
                                paragraph.className = "details";
                                paragraph.innerHTML = data.Details;
                                element.parentNode.insertBefore(paragraph, element);
                            }
                        });
                    }).catch((err) => {
                        console.log("api not working");
                    });
            };
        });

        function grabAllMovies() {
            fetch('/api/movies/getmovies').
                then((response) => {
                    if (response.status !== 200) {
                        console.log('Looks like there was a problem. Status Code: ' +
                            response.status);
                        return;
                    }
                    response.json().then(function (data) {
                        var div;
                        for (let i = 0; i < data.length; i++) {
                            if (i % 3 == 0) {
                                div = document.createElement("div");
                                div.className = "row";
                                document.getElementById("movies").appendChild(div);
                            }
                            var movie = document.createElement("div");
                            movie.className = "col-md-3";
                            movie.style = "text-align:center; margin:10px; border-radius: 10px; border:3px; background-color:#afe6af; padding-bottom:5px; padding-top:5px;";
                            movie.innerHTML = "<img src='" + data[i].imageurl + "' style='height:auto; width:25%;'><h2>" + data[i].Title + "</h2><p>" + data[i].Category + "</p><button data-id='" + data[i].Id + "' id='moreDetails' class='btn btn-success'>More Details</button>";
                            div.appendChild(movie);
                        }
                    });
                }).catch((err) => {
                    console.log("api not working");
                });
        }

        documentready(() => {
            console.log("hello");
            grabAllMovies();
        });
    </script>
</body>
</html>